**Deploy Django app to VPS with git hooks**

# 1. Create a github repo and download it to the local machine:
- Download repo: ``git clone <url>``
- Change directory to the cloned folder: ``cd <folder>``

# 2. Setup a django project:
- Create a virtual env: ``python3 -m venv env``
- Activate a virtual enironment: ``source env/bin/activate``
- Install django on virtual environment: ``pip install django``
- Create a django project: ``django-admin startproject <project_name>``
- Create a requirements.txt file: ``pip freeze > requirements.txt``

# 3. Ignore files from being tracked by Git:
- Create a .gitignore file with no extension.
- Ignore the virtual env files, cached files, files generated by IDE and settings.py file.
```python
env/
*.pyc
.vscode/
root_name/project_name/settings.py
```
- Add the files to github staging: ``git add .``
- Commit: ``git commit -m <commit -message>``

> Note: Every time changes is made to the file commit those files from the root directory.

# Setting server to trigger the hook:
- Setting git on server. Make sure git is installed or ``sudo apt-get install git``
- Setting server to execute the git hooks.

## 4.1 Setting up git repo on server
- SSH into server terminal: ``ssh root@ip``
- Create a directory on server and cd into it: ``mkdir <dir_name> && cd <dir_name>``
- Create a directory for storing the project files: ``mkdir <deploy_dir_name>``. Files pushed will be saved on this directory.
- Create a directory for storing git files ``cd <app_name>.git``.
- CD into git folder: ``cd <app_name>.git`` 
- Create a bare git repository: ``git init --bare``

## 4.2 Setting git hooks:
- CD into hooks: ``cd hooks``. Hooks are events that gets triggered automatically by git when event(push, commit) occurs.
- Create a post_receive hook. ``nano post_receive``, copy following bash code and modify TARGET and GITDIR vars.
[Script Source](https://stackoverflow.com/a/53084830/10901575)

```bash
#!/bin/bash
TRAGET="/root/webuser/deploy-folder" # path to deploy folder created in step 4.1
GIT_DIR="/home/webuser/www.git" # path to git directory created in step 4.1
BRANCH="master"

while read oldrev newrev ref
do
    # only checking out the master (or whatever branch you would like to deploy)
    if [[ $ref = refs/heads/$BRANCH ]];
    then
        echo "Ref $ref received. Deploying ${BRANCH} branch to production..."
        git --work-tree=$TRAGET --git-dir=$GIT_DIR checkout -f
    else
        echo "Ref $ref received. Doing nothing: only the ${BRANCH} branch may be deployed on this server."
    fi
done
```

- Save(ctrl+o) and exit (ctrl+x)
- Make the hook script executable for current user: ``chmod u+x post_receive``


# 5. Setting up local machine:

- Setting up ssh based authentication by creating ssh key so that you dont need to type passwordjangod each time you pull.
- Create a remote url to point server's git file

## 5.1 Setting up SSH based authentication
- Crate a ssh key pair : ``ssh-keygen -t rsa`` By default key is saved at /home/user/.ssh/
- Copy public key to server: ``ssh-copy-id -i ~/.ssh/<key_file> user@ip`` and enter the server password.
- Test acccess using: ``ssh user@ip``


## 5.2 Create a remote url to point server's git file:
- Create a remote: ``git remote add <remote_name> ssh://user@ip:/path/to/git_file_create_on_4.1``. Ex: ``git remote add live ssh://root@192.168.0.1:/root/django/git_file.sh``
- View the remote thus created: ``git remote -v``



# 6. Testing Deployment:
- Make changes to file and add files: ``git add .``
- Commit files: ``git commit -m `<commit message>``
- Push to the remote live: ``git push <>``



